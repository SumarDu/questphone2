# Quest Timer Widget

## Опис

Повністю автономний віджет для домашнього екрану (home screen), який відображає центральний таймер застосунку разом з кнопками керування в режимі реального часу. **Весь функціонал доступний безпосередньо з віджета без переходу в головний застосунок.**

## Особливості

- **Повна автономність**: Всі дії виконуються безпосередньо з віджета через діалогові вікна
- **Синхронізація в реальному часі**: Віджет оновлюється кожну секунду, відображаючи актуальний стан таймера без затримок
- **Ідентичний вигляд**: Дизайн віджета відповідає головному екрану застосунку
- **Інтерактивні кнопки**:
  - **Info (ліворуч)**: Перемикання інформаційного режиму
  - **Timer (центр)**: Виконує різні дії залежно від режиму
  - **Add (праворуч)**: Відкриває діалог додавання часу або вибору квесту

## Функціонал кнопок

### Кнопка Info (ліва)
- Перемикає інформаційний режим
- Показує загальний час з початку активності
- Доступна в режимах: QUEST_COUNTDOWN, BREAK, INFO

### Кнопка Timer (центр)
Залежно від режиму виконує різні дії:
- **QUEST_COUNTDOWN / INACTIVE**: Відкриває діалог для початку незапланованої перерви (unplanned break)
- **BREAK**: Дочасно завершує перерву
- **UNPLANNED_BREAK**: Зупиняє незаплановану перерву
- **Інші режими**: Клік ігнорується

### Кнопка Add (права)
Залежно від режиму відкриває різні діалоги:
- **QUEST_COUNTDOWN / OVERTIME (quest)**: Діалог додавання часу (5/10/15 хв)
- **BREAK / OVERTIME (break)**: Діалог вибору нового квесту
- Неактивна в режимах: UNPLANNED_BREAK, INFO, UNLOCK

## Діалогові вікна

### 1. WidgetAddTimeDialogActivity
- Дозволяє додати 5, 10 або 15 хвилин до поточного квесту
- Зміни відразу застосовуються через TimerService

### 2. WidgetQuestSelectionDialogActivity
- Показує список доступних квестів (з урахуванням фільтрів)
- Дозволяє клонувати і запустити вибраний квест
- Підтримує фільтрацію квестів (повторювані, клоновані, одноразові)

### 3. WidgetUnplannedBreakDialogActivity
- Дозволяє ввести або вибрати причину незапланованої перерви
- Кнопки: "Start" (почати зараз), "Later" (відкласти), "Cancel"
- Підтримує збережені причини з налаштувань

### 4. WidgetDeferredReasonDialogActivity
- Автоматично відкривається після закінчення відкладеної незапланованої перерви
- Запитує причину перерви постфактум

## Технічна реалізація

### Компоненти

1. **TimerWidgetProvider** (`widget/TimerWidgetProvider.kt`)
   - AppWidgetProvider для обробки подій віджета
   - Обробляє кліки на кнопки з контекстом режиму
   - Запускає відповідні діалоги або сервісні дії
   - Оновлює UI віджета

2. **TimerWidgetUpdateService** (`widget/TimerWidgetUpdateService.kt`)
   - Фоновий сервіс для моніторингу стану таймера
   - Підписується на StateFlow з TimerService
   - Транслює зміни до всіх віджетів у реальному часі
   - Автоматично відкриває діалог відкладеної причини

3. **Діалогові Activity** (4 штуки)
   - Прозорі Activity з theme Dialog
   - Використовують Jetpack Compose для UI
   - Відкриваються поверх інших застосунків
   - excludeFromRecents для відсутності в списку останніх

4. **Layout** (`res/layout/timer_widget_layout.xml`)
   - RelativeLayout з трьома елементами: дві кнопки і текст таймера
   - Адаптивний дизайн з підтримкою різних розмірів

5. **Конфігурація** (`res/xml/timer_widget_info.xml`)
   - Мінімальні розміри: 250dp x 110dp
   - updatePeriodMillis=0 (оновлення керується сервісом)
   - Підтримка горизонтального і вертикального масштабування

### Колірна схема таймера

Колір тексту таймера змінюється залежно від режиму:
- **QUEST_COUNTDOWN**: Синій (#1976D2)
- **OVERTIME**: Червоний (#DC143C)
- **BREAK**: Зелений (#4CAF50)
- **UNPLANNED_BREAK**: Сірий (#808080)
- **INFO**: Фіолетовий (#8A2BE2)
- **UNLOCK**: Жовтий (#FFEB3B)

### Логіка кнопок

- **Info кнопка**: Активна тільки в режимах QUEST_COUNTDOWN, BREAK, INFO
- **Add кнопка**: Неактивна в режимах UNPLANNED_BREAK, INFO, UNLOCK та під час Deep Focus блокування

## Використання

1. Після встановлення застосунку, віджет з'явиться в списку доступних віджетів
2. Довге натискання на порожньому місці home screen → Widgets
3. Знайдіть "Quest Timer Widget" і перетягніть на екран
4. Віджет автоматично почне відображати поточний стан таймера

### Приклади використання

**Додавання часу до квесту:**
1. Під час активного квесту натисніть кнопку Add (права)
2. У діалозі виберіть 5, 10 або 15 хвилин
3. Час буде додано миттєво

**Початок незапланованої перерви:**
1. Під час активного квесту натисніть на текст таймера
2. У діалозі введіть або виберіть причину
3. Натисніть "Start" або "Later" (для відкладення)

**Вибір нового квесту після перерви:**
1. Під час перерви натисніть кнопку Add
2. У списку виберіть потрібний квест
3. Квест буде клоновано і запущено автоматично

## Примітки для розробників

- Віджет автоматично запускає `TimerWidgetUpdateService` при додаванні першого віджета
- Сервіс зупиняється при видаленні останнього віджета
- Оновлення відбуваються через broadcast intents
- Діалоги використовують FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK
- Всі дії виконуються через Intent до TimerService або безпосередньо до бази даних
- PendingIntent'и створюються з FLAG_IMMUTABLE для сумісності з Android 12+

## Архітектурні рішення

### Чому окремі діалогові Activity?
- RemoteViews (стандарт для віджетів) мають обмежену функціональність
- Не підтримують складні UI елементи (списки з прокруткою, текстові поля)
- Діалогові Activity дозволяють використовувати повний Compose UI
- Можуть відображатися поверх інших застосунків

### Чому не Notification зActions?
- Notification actions обмежені простими кнопками
- Не підтримують введення тексту або вибір зі списку
- Dialog Activity забезпечує краще UX

## Відомі обмеження

- Для роботи віджета потрібно, щоб TimerService був активний
- Діалоги можуть не відображатися на деяких лаунчерах через обмеження системи
- На Android 12+ потрібен дозвіл SYSTEM_ALERT_WINDOW для діалогів (вже є в manifest)
